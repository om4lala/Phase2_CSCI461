# # This CD workflow runs on every push to main. It deploys the latest code to our EC2 instance on AWS by copying the repo over SSH and running docker compose up -d --build on the instance. This satisfies the 'automated deployment to AWS after merge' requirement.
# name: CD - Deploy to AWS

# on:
#   push:
#     branches: ["main"]

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest-----BEGIN OPENSSH PRIVATE KEY-----


#     steps:
#       - name: Checkout repo
#         uses: actions/checkout@v4

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ secrets.AWS_REGION }}

#       - name: Create app directory on EC2
#         uses: appleboy/ssh-action@v1.2.0
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             mkdir -p /home/${{ secrets.EC2_USER }}/app

#       - name: Copy code to EC2
#         uses: appleboy/scp-action@v0.1.7
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key: ${{ secrets.EC2_SSH_KEY }}
#           source: "."
#           target: "/home/${{ secrets.EC2_USER }}/app"

#       - name: Prepare SSH key and known_hosts
#         run: |
#           if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
#             echo "EC2_SSH_KEY secret is not set. Failing."
#             exit 1
#           fi
#           mkdir -p ~/.ssh
#           echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
#           chmod 600 ~/.ssh/id_rsa# add EC2 host to known_hosts to avoid interactive prompt
#           ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

#       - name: Deploy on EC2
#         uses: appleboy/ssh-action@v1.2.0
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             set -e
#             cd /home/${{ secrets.EC2_USER }}/app
#             echo "Building and starting containers..."
#             docker compose up -d --build
#             echo "Verifying container is running..."
#             docker ps | grep trustworthy-registry || (echo "Error: Container not running!" && exit 1)
#             echo "Deployment complete."


name: CD - Deploy to AWS

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # AWS credentials are optional if you're only using SSH deployment
      # If you need AWS services (ECR, S3, etc.), ensure your secrets are valid:
      # - AWS_ACCESS_KEY_ID: Must be a valid IAM access key
      # - AWS_SECRET_ACCESS_KEY: Must match the access key (no extra spaces/newlines)
      # - AWS_REGION: Must be a valid AWS region (e.g., us-east-1, us-west-2)
      - name: Configure AWS credentials
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Create app directory on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p /home/${{ secrets.EC2_USER }}/app

      - name: Copy code to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: "/home/${{ secrets.EC2_USER }}/app"

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /home/${{ secrets.EC2_USER }}/app
            echo "Building and starting containers..."
            docker compose up -d --build
            echo "Verifying container is running..."
            docker ps | grep trustworthy-registry || (echo "Error: Container not running!" && exit 1)
            echo "Deployment complete."
